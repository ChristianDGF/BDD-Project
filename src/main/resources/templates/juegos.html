<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gestión de Juegos</title>

  <link th:href="@{https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css}"
        rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
        crossorigin="anonymous">

  <style>
    body {
      background-color: #f5f7fb;
    }
    .navbar-brand {
      font-weight: 700;
      letter-spacing: 0.03em;
    }
    .card {
      border-radius: 0.8rem;
    }
    .table thead {
      background-color: #0d6efd;
      color: #fff;
    }
    .table tbody tr:hover {
      background-color: #f1f5ff;
    }
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
  <div class="container-fluid">
    <a class="navbar-brand" th:href="@{/}">BasketDB</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
            data-bs-target="#navbarContent" aria-controls="navbarContent"
            aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarContent">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item">
          <a class="nav-link" th:href="@{/ciudades}">Ciudades</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" th:href="@{/equipos}">Equipos</a>
        </li>
        <li class="nav-item">
          <a class="nav-link active" th:href="@{/juegos}">Juegos</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" th:href="@{/jugadores}">Jugadores</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" th:href="@{/captura-estadisticas}">Captura Estadísticas</a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<div class="container">

  <div class="row mb-4">
    <!-- Formulario -->
    <div class="col-md-5">
      <div class="card shadow-sm">
        <div class="card-header bg-white">
          <h5 class="mb-0" id="formTitle">Registrar Juego</h5>
          <small class="text-muted">Los códigos se generan automáticamente.</small>
        </div>
        <div class="card-body">
          <form id="juegoForm" class="row g-3">
            <input type="hidden" id="codJuego" name="codJuego">

            <div class="col-12">
              <label for="descripcion" class="form-label">Descripción</label>
              <input type="text" class="form-control" id="descripcion" name="descripcion"
                     placeholder="Ej. Partido inaugural" required>
            </div>

            <div class="col-12">
              <label for="fecha" class="form-label">Fecha del juego</label>
              <input type="date" class="form-control" id="fecha" name="fecha" required>
            </div>

            <div class="col-12">
              <label for="equipoLocal" class="form-label">Equipo Local</label>
              <select id="equipoLocal" name="equipoLocal" class="form-select" required>
                <option value="" disabled selected>Seleccione equipo local...</option>
              </select>
            </div>

            <div class="col-12">
              <label for="equipoVisitante" class="form-label">Equipo Visitante</label>
              <select id="equipoVisitante" name="equipoVisitante" class="form-select" required>
                <option value="" disabled selected>Seleccione equipo visitante...</option>
              </select>
            </div>

            <div class="col-12 d-flex gap-2">
              <button type="submit" class="btn btn-primary">
                <span id="btnText">Guardar</span>
              </button>
              <button type="button" class="btn btn-outline-secondary" id="btnLimpiar">
                Limpiar
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Tabla -->
    <div class="col-md-7">
      <div class="card shadow-sm">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Listado de Juegos</h5>
          <button class="btn btn-sm btn-outline-primary" type="button" onclick="cargarJuegos()">
            Recargar
          </button>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table mb-0 align-middle">
              <thead>
              <tr>
                <th class="text-center" style="width: 8%;">ID</th>
                <th>Descripción</th>
                <th>Fecha</th>
                <th>Local</th>
                <th>Visitante</th>
                <th class="text-center" style="width: 20%;">Acciones</th>
              </tr>
              </thead>
              <tbody id="juegosTableBody">
              <!-- JS -->
              </tbody>
            </table>
          </div>
          <div class="p-3 text-muted small" id="estadoTabla">
            Cargando juegos...
          </div>
        </div>
      </div>
    </div>

  </div>

</div>

<script th:src="@{https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js}"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

<script>
  const apiJuegos = '/api/juegos';
  const apiEquipos = '/api/equipos';

  const equiposMap = {}; // { codEquipo: nombre }

  document.addEventListener('DOMContentLoaded', () => {
    cargarEquiposSelects();
    cargarJuegos();

    document.getElementById('juegoForm').addEventListener('submit', guardarJuego);
    document.getElementById('btnLimpiar').addEventListener('click', limpiarFormulario);
  });

  function cargarEquiposSelects() {
    fetch(apiEquipos)
            .then(r => {
              if (!r.ok) throw new Error('Error al cargar equipos');
              return r.json();
            })
            .then(data => {
              const selLocal = document.getElementById('equipoLocal');
              const selVisitante = document.getElementById('equipoVisitante');

              selLocal.innerHTML = '<option value="" disabled selected>Seleccione equipo local...</option>';
              selVisitante.innerHTML = '<option value="" disabled selected>Seleccione equipo visitante...</option>';

              data.forEach(e => {
                equiposMap[e.codEquipo] = e.nombre;

                const opt1 = document.createElement('option');
                opt1.value = e.codEquipo;
                opt1.textContent = e.nombre;

                const opt2 = document.createElement('option');
                opt2.value = e.codEquipo;
                opt2.textContent = e.nombre;

                selLocal.appendChild(opt1);
                selVisitante.appendChild(opt2);
              });
            })
            .catch(err => {
              console.error(err);
              alert('No se pudieron cargar los equipos.');
            });
  }

  function cargarJuegos() {
    const estado = document.getElementById('estadoTabla');
    estado.textContent = 'Cargando juegos...';

    fetch(apiJuegos)
            .then(r => {
              if (!r.ok) throw new Error('Error al cargar juegos');
              return r.json();
            })
            .then(data => {
              const tbody = document.getElementById('juegosTableBody');
              tbody.innerHTML = '';

              if (data.length === 0) {
                estado.textContent = 'No hay juegos registrados.';
              } else {
                estado.textContent = `Total de juegos: ${data.length}`;
              }

              data.forEach(j => {
                const tr = document.createElement('tr');

                const tdId = document.createElement('td');
                tdId.classList.add('text-center', 'fw-semibold');
                tdId.textContent = j.codJuego;

                const tdDesc = document.createElement('td');
                tdDesc.textContent = j.descripcion || '';

                const tdFecha = document.createElement('td');
                // j.fecha viene como "yyyy-MM-dd"
                tdFecha.textContent = j.fecha || '';

                const tdLocal = document.createElement('td');
                tdLocal.textContent = equiposMap[j.equipoLocal] || `ID ${j.equipoLocal}`;

                const tdVisit = document.createElement('td');
                tdVisit.textContent = equiposMap[j.equipoVisitante] || `ID ${j.equipoVisitante}`;

                const tdAcciones = document.createElement('td');
                tdAcciones.classList.add('text-center');

                const btnEditar = document.createElement('button');
                btnEditar.textContent = 'Editar';
                btnEditar.className = 'btn btn-sm btn-outline-primary me-2';
                btnEditar.onclick = () => editarJuego(j);

                const btnEliminar = document.createElement('button');
                btnEliminar.textContent = 'Eliminar';
                btnEliminar.className = 'btn btn-sm btn-outline-danger';
                btnEliminar.onclick = () => eliminarJuego(j.codJuego);

                tdAcciones.appendChild(btnEditar);
                tdAcciones.appendChild(btnEliminar);

                tr.appendChild(tdId);
                tr.appendChild(tdDesc);
                tr.appendChild(tdFecha);
                tr.appendChild(tdLocal);
                tr.appendChild(tdVisit);
                tr.appendChild(tdAcciones);

                tbody.appendChild(tr);
              });
            })
            .catch(err => {
              console.error(err);
              estado.textContent = 'Ocurrió un error al cargar los juegos.';
            });
  }

  function guardarJuego(event) {
    event.preventDefault();

    const codJuego = document.getElementById('codJuego').value;
    const descripcion = document.getElementById('descripcion').value.trim();
    const fecha = document.getElementById('fecha').value;
    const equipoLocal = document.getElementById('equipoLocal').value;
    const equipoVisitante = document.getElementById('equipoVisitante').value;

    if (!descripcion) {
      alert('La descripción es obligatoria.');
      return;
    }
    if (!fecha) {
      alert('La fecha es obligatoria.');
      return;
    }
    if (!equipoLocal || !equipoVisitante) {
      alert('Debe seleccionar ambos equipos.');
      return;
    }
    if (equipoLocal === equipoVisitante) {
      alert('El equipo local y el visitante no pueden ser el mismo.');
      return;
    }

    const juego = {
      descripcion: descripcion,
      fecha: fecha, // LocalDate en el backend interpreta "yyyy-MM-dd"
      equipoLocal: Number(equipoLocal),
      equipoVisitante: Number(equipoVisitante)
    };

    let url = apiJuegos;
    let method = 'POST';

    if (codJuego) {
      url = `${apiJuegos}/${codJuego}`;
      method = 'PUT';
    }

    fetch(url, {
      method: method,
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(juego)
    })
            .then(r => {
              if (!r.ok) throw new Error('Error al guardar el juego');
              return r.json();
            })
            .then(() => {
              alert(codJuego ? 'Juego actualizado correctamente' : 'Juego creado correctamente');
              limpiarFormulario();
              cargarJuegos();
            })
            .catch(err => {
              console.error(err);
              alert('Ocurrió un error al guardar el juego');
            });
  }

  function editarJuego(juego) {
    document.getElementById('codJuego').value = juego.codJuego;
    document.getElementById('descripcion').value = juego.descripcion || '';
    document.getElementById('fecha').value = juego.fecha || '';
    document.getElementById('equipoLocal').value = juego.equipoLocal;
    document.getElementById('equipoVisitante').value = juego.equipoVisitante;

    document.getElementById('formTitle').textContent = 'Editar Juego';
    document.getElementById('btnText').textContent = 'Actualizar';
  }

  function eliminarJuego(codJuego) {
    if (!confirm('¿Seguro que deseas eliminar este juego?')) return;

    fetch(`${apiJuegos}/${codJuego}`, { method: 'DELETE' })
            .then(r => {
              if (!r.ok && r.status !== 204) {
                throw new Error('Error al eliminar el juego');
              }
              alert('Juego eliminado correctamente');
              cargarJuegos();
            })
            .catch(err => {
              console.error(err);
              alert('Ocurrió un error al eliminar el juego');
            });
  }

  function limpiarFormulario() {
    document.getElementById('juegoForm').reset();
    document.getElementById('codJuego').value = '';
    document.getElementById('formTitle').textContent = 'Registrar Juego';
    document.getElementById('btnText').textContent = 'Guardar';
  }
</script>

</body>
</html>
